# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∞–≤–∞—Ç–∞—Ä–æ–≤

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:

- **PostgreSQL** –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- **MinIO/S3** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- **CDN** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–¥–∞—á–∏
- **Presigned URL** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ **lifecycle-–ø—Ä–∞–≤–∏–ª–∞**

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå **404 –æ—à–∏–±–∫–∏** ‚Üí ‚úÖ –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ CDN
- ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏** ‚Üí ‚úÖ –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Üí ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå **–ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** ‚Üí ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π ImageService

### üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **Presigned URL** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –∞–≤–∞—Ç–∞—Ä–æ–≤
- **CDN** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–¥–∞—á–∏
- **Lifecycle-–ø—Ä–∞–≤–∏–ª–∞** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –º–µ—Ç—Ä–∏–∫–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ Redis

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker –∏ Docker Compose
- Java 17+
- Maven 3.6+
- PostgreSQL 15+ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω)
- MinIO –∏–ª–∏ AWS S3
- Redis (–¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `pom.xml`:
- `software.amazon.awssdk:s3` - –¥–ª—è AWS S3
- `io.minio:minio` - –¥–ª—è MinIO
- `org.postgresql:postgresql` - –¥–ª—è PostgreSQL
- `org.flywaydb:flyway-core` - –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- `org.springframework.boot:spring-boot-starter-data-redis` - –¥–ª—è Redis

## üõ† –ü–æ—à–∞–≥–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

#### 1.1 –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```bash
cd src/backend
docker-compose up -d postgres minio redis
```

#### 1.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MinIO
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MinIO Client (mc)
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è bucket
./scripts/init-minio.sh
```

#### 1.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
# PostgreSQL
docker exec taskboard-postgres pg_isready -U taskboard -d taskboarddb

# MinIO
curl http://localhost:9000/minio/health/live

# Redis
docker exec taskboard-redis redis-cli ping
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω)
```sql
CREATE DATABASE taskboarddb;
CREATE USER taskboard WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE taskboarddb TO taskboard;
```

#### 2.2 –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Flyway
# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
mvn flyway:migrate
```

### –®–∞–≥ 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### 3.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π:

**application-dev.properties:**
```properties
# Development —Å H2
spring.datasource.url=jdbc:h2:mem:taskboarddb
spring.datasource.driverClassName=org.h2.Driver

# MinIO –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
app.storage.provider=minio
app.storage.endpoint=http://localhost:9000
app.storage.access-key=minioadmin
app.storage.secret-key=minioadmin
app.storage.bucket-name=taskboard-avatars
```

**application-prod.properties:**
```properties
# Production —Å PostgreSQL
spring.datasource.url=jdbc:postgresql://localhost:5432/taskboarddb
spring.datasource.driverClassName=org.postgresql.Driver
spring.datasource.username=taskboard
spring.datasource.password=password

# AWS S3 –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
app.storage.provider=s3
app.storage.endpoint=https://s3.amazonaws.com
app.storage.access-key=${AWS_ACCESS_KEY_ID}
app.storage.secret-key=${AWS_SECRET_ACCESS_KEY}
app.storage.bucket-name=taskboard-avatars-prod
app.storage.region=us-east-1
app.storage.cdn-base-url=https://cdn.taskboard.com
```

### –®–∞–≥ 4: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

#### 4.1 –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤
```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
./scripts/migrate-existing-avatars.sh
```

#### 4.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∞–≤–∞—Ç–∞—Ä—ã –≤ —Ç–∞–±–ª–∏—Ü–µ users
UPDATE users 
SET avatar = CONCAT('https://cdn.taskboard.com/avatars/', id, '/current.jpg')
WHERE avatar IS NOT NULL AND avatar != '';
```

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 5.1 –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

#### 5.2 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
```bash
# 1. –ü–æ–ª—É—á–µ–Ω–∏–µ presigned URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
curl -X POST http://localhost:3000/api/avatars/upload-url \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "avatar.jpg",
    "contentType": "image/jpeg",
    "fileSize": 1024000
  }'

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ presigned URL
curl -X PUT "PRESIGNED_URL_FROM_STEP_1" \
  -H "Content-Type: image/jpeg" \
  --upload-file avatar.jpg

# 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
curl -X POST http://localhost:3000/api/avatars/confirm \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "storageKey": "STORAGE_KEY_FROM_STEP_1"
  }'

# 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
curl -X GET http://localhost:3000/api/avatars/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CDN

### –í–∞—Ä–∏–∞–Ω—Ç 1: Nginx –∫–∞–∫ CDN
```nginx
# nginx/nginx.conf
server {
    listen 80;
    server_name cdn.taskboard.com;

    location /avatars/ {
        proxy_pass http://minio:9000/taskboard-avatars/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        expires 1d;
        add_header Cache-Control "public, immutable";
        
        # CORS
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
    }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: AWS CloudFront
1. –°–æ–∑–¥–∞–π—Ç–µ CloudFront Distribution
2. Origin: S3 bucket
3. Behaviors: `/avatars/*` ‚Üí Cache based on query strings
4. CNAME: `cdn.taskboard.com`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –º–µ—Ç—Ä–∏–∫–∏
```yaml
# prometheus/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'taskboard-api'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/actuator/prometheus'
```

### Grafana –¥–∞—à–±–æ—Ä–¥—ã
–°–æ–∑–¥–∞–π—Ç–µ –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∑–æ–∫ –∞–≤–∞—Ç–∞—Ä–æ–≤
- –†–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- Latency API
- –û—à–∏–±–∫–∏ 4xx/5xx

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT –≤–∞–ª–∏–¥–∞—Ü–∏—è
```java
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
@PreAuthorize("isAuthenticated()")
@PreAuthorize("#userId == authentication.principal.id")
```

### CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("https://taskboard.com"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/api/avatars/**", configuration);
        return source;
    }
}
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ AWS S3
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ S3 bucket
aws s3 mb s3://taskboard-avatars-prod

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ versioning
aws s3api put-bucket-versioning \
  --bucket taskboard-avatars-prod \
  --versioning-configuration Status=Enabled

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ lifecycle
aws s3api put-bucket-lifecycle-configuration \
  --bucket taskboard-avatars-prod \
  --lifecycle-configuration file://lifecycle.json
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CloudFront
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ CloudFront Distribution
aws cloudfront create-distribution \
  --distribution-config file://cloudfront-config.json
```

### 3. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
# –°–±–æ—Ä–∫–∞
mvn clean package -DskipTests

# –ó–∞–ø—É—Å–∫ —Å –ø—Ä–æ–¥–∞–∫—à–Ω –ø—Ä–æ—Ñ–∏–ª–µ–º
java -jar target/taskboard-api-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod
```

## üîÑ Rollback –ø–ª–∞–Ω

### –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
1. **–û—Ç–∫–∞—Ç –∫ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ:**
   ```bash
   # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
   pg_restore -d taskboarddb backup.sql
   
   # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–∞—Ä—ã–µ endpoints
   # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   ```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:**
   ```bash
   # –ò–∑ S3/MinIO
   aws s3 sync s3://taskboard-avatars-backup ./local-avatars/
   ```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- **Upload success rate** > 95%
- **API response time** < 500ms
- **Storage usage** < 80%
- **CDN hit ratio** > 90%

### –ê–ª–µ—Ä—Ç—ã:
- –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ > 5%
- –í—ã—Å–æ–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å API
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- –ü—Ä–æ–±–ª–µ–º—ã —Å CDN

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```bash
mvn test -Dtest=AvatarServiceTest
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```bash
mvn test -Dtest=AvatarControllerIntegrationTest
```

### Load —Ç–µ—Å—Ç—ã
```bash
# –ò—Å–ø–æ–ª—å–∑—É—è Apache Bench
ab -n 1000 -c 10 http://localhost:3000/api/avatars/me
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [AWS S3 Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/best-practices.html)
- [MinIO Documentation](https://docs.min.io/)
- [Spring Boot File Upload](https://spring.io/guides/gs/uploading-files/)
- [Flyway Migration Guide](https://flywaydb.org/documentation/)

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs -f`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏: http://localhost:9090
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Grafana: http://localhost:3001
4. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

**–£–¥–∞—á–∏ —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π! üöÄ** 
