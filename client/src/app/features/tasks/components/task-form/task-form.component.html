<form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
  <div class="form-header">
    <h2>{{ isEditMode ? 'Edit Task' : 'Create New Task' }}</h2>
  </div>

  <div class="form-content">
    <!-- Title -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Title</mat-label>
      <input matInput formControlName="title" placeholder="Enter task title">
      <mat-error *ngIf="taskForm.get('title')?.hasError('required')">
        {{ getErrorMessage('title') }}
      </mat-error>
      <mat-error *ngIf="taskForm.get('title')?.hasError('minlength')">
        {{ getErrorMessage('title') }}
      </mat-error>
      <mat-error *ngIf="taskForm.get('title')?.hasError('maxlength')">
        {{ getErrorMessage('title') }}
      </mat-error>
    </mat-form-field>

    <!-- Description -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Description</mat-label>
      <textarea matInput formControlName="description" 
                placeholder="Enter task description" 
                rows="3"></textarea>
      <mat-error *ngIf="taskForm.get('description')?.hasError('maxlength')">
        {{ getErrorMessage('description') }}
      </mat-error>
    </mat-form-field>

    <div class="form-row">
      <!-- Status -->
      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status">
          <mat-option *ngFor="let status of statuses" [value]="status">
            {{ status | titlecase }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="taskForm.get('status')?.hasError('required')">
          {{ getErrorMessage('status') }}
        </mat-error>
      </mat-form-field>

      <!-- Priority -->
      <mat-form-field appearance="outline">
        <mat-label>Priority</mat-label>
        <mat-select formControlName="priority">
          <mat-option *ngFor="let priority of priorities" [value]="priority">
            {{ priority | titlecase }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="taskForm.get('priority')?.hasError('required')">
          {{ getErrorMessage('priority') }}
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row">
      <!-- Project -->
      <mat-form-field appearance="outline">
        <mat-label>Project</mat-label>
        <mat-select formControlName="projectId">
          <mat-option *ngFor="let project of projects" [value]="project.id">
            {{ project.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="taskForm.get('projectId')?.hasError('required')">
          {{ getErrorMessage('projectId') }}
        </mat-error>
      </mat-form-field>

      <!-- Assignee -->
      <mat-form-field appearance="outline">
        <mat-label>Assignee</mat-label>
        <mat-select formControlName="assigneeId">
          <mat-option value="">Unassigned</mat-option>
          <mat-option *ngFor="let user of users" [value]="user.id">
            {{ user.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="form-row">
      <!-- Due Date -->
      <mat-form-field appearance="outline">
        <mat-label>Due Date</mat-label>
        <input matInput [matDatepicker]="dueDatePicker" formControlName="dueDate">
        <mat-datepicker-toggle matIconSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #dueDatePicker></mat-datepicker>
        <mat-error *ngIf="taskForm.get('dueDate')?.hasError('pastDueDate')">
          {{ getErrorMessage('dueDate') }}
        </mat-error>
      </mat-form-field>

      <!-- Estimated Hours -->
      <mat-form-field appearance="outline">
        <mat-label>Estimated Hours</mat-label>
        <input matInput type="number" formControlName="estimatedHours" 
               placeholder="0" min="0" max="1000">
        <mat-error *ngIf="taskForm.get('estimatedHours')?.hasError('min')">
          {{ getErrorMessage('estimatedHours') }}
        </mat-error>
        <mat-error *ngIf="taskForm.get('estimatedHours')?.hasError('max')">
          {{ getErrorMessage('estimatedHours') }}
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Labels -->
    <div class="labels-section">
      <h3>Labels</h3>
      <div class="labels-container">
        <mat-chip-set>
          <mat-chip *ngFor="let label of taskForm.get('labels')?.value" 
                   [style.background-color]="label.color"
                   (removed)="removeLabel(label.name)">
            {{ label.name }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      </div>
      
      <div class="available-labels">
        <h4>Available Labels</h4>
        <div class="label-buttons">
          <button mat-stroked-button 
                  *ngFor="let label of availableLabels"
                  [style.border-color]="label.color"
                  [style.color]="label.color"
                  (click)="addLabel(label)"
                  [disabled]="taskForm.get('labels')?.value?.includes(label)">
            {{ label.name }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <button mat-button type="button" (click)="onCancel()">
      Cancel
    </button>
    <button mat-raised-button 
            color="primary" 
            type="submit"
            [disabled]="!isFormValid || !isFormDirty">
      {{ isEditMode ? 'Update Task' : 'Create Task' }}
    </button>
  </div>
</form>
