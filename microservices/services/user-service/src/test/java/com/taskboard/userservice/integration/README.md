# Интеграционные тесты User Service

## Обзор

Этот пакет содержит интеграционные тесты для User Service, которые тестируют взаимодействие между различными слоями приложения с реальными внешними зависимостями.

## Структура тестов

### Базовые классы

- **`BaseIntegrationTest`** - Базовый класс для всех интеграционных тестов
  - Настраивает Testcontainers (PostgreSQL, Kafka, Redis)
  - Предоставляет общие утилиты и конфигурацию
  - Настраивает динамические свойства для контейнеров

- **`TestDataFactory`** - Фабрика для создания тестовых данных
  - Создает DTO объекты для тестов
  - Предоставляет методы для bulk операций
  - Создает валидные и невалидные тестовые данные

### Тестовые классы

#### 1. UserRepositoryIntegrationTest
Тестирует взаимодействие с базой данных PostgreSQL через репозитории.

**Покрываемые сценарии:**
- Поиск пользователей по ID, username, email
- Поиск пользователей по статусу и роли
- Создание, обновление и удаление пользователей
- Проверка существования пользователей
- Подсчет пользователей по критериям

#### 2. UserUseCaseIntegrationTest
Тестирует бизнес-логику Use Cases с реальной базой данных.

**Покрываемые сценарии:**
- Создание пользователей с валидацией
- Получение пользователей по ID
- Обновление пользователей
- Удаление пользователей
- Аутентификация пользователей
- Обработка ошибок и исключений

#### 3. KafkaEventIntegrationTest
Тестирует публикацию и обработку событий через Kafka.

**Покрываемые сценарии:**
- Публикация событий создания пользователей
- Публикация событий обновления пользователей
- Публикация событий удаления пользователей
- Обработка ошибок подключения к Kafka
- Проверка сериализации событий

#### 4. UserControllerIntegrationTest
Тестирует REST API контроллеры (будет работать после реализации контроллеров).

**Покрываемые сценарии:**
- CRUD операции через REST API
- Валидация входных данных
- Обработка ошибок HTTP
- CORS настройки
- Аутентификация через API

#### 5. UserServicePerformanceTest
Тестирует производительность сервиса под нагрузкой.

**Покрываемые сценарии:**
- Bulk операции создания пользователей
- Concurrent операции
- Производительность чтения данных
- Смешанные операции (create/read)
- Нагрузочное тестирование

## Технологии

### Testcontainers
- **PostgreSQL** - Реальная база данных для тестов
- **Kafka** - Очередь сообщений для событий
- **Redis** - Кэш для сессий (если используется)

### Дополнительные библиотеки
- **WireMock** - Мокирование внешних сервисов
- **H2** - In-memory база для unit тестов
- **Spring Test** - Интеграция с Spring контекстом

## Конфигурация

### application-integration-test.yml
Содержит конфигурацию для интеграционных тестов:
- Настройки базы данных
- Конфигурация Kafka
- Настройки безопасности
- Логирование

### test-data.sql
Инициализационные данные для PostgreSQL контейнера:
- Тестовые пользователи
- Аудит записи
- Сброс последовательностей

## Запуск тестов

### Все интеграционные тесты
```bash
mvn test -Dtest="*IntegrationTest"
```

### Конкретный тест
```bash
mvn test -Dtest="UserRepositoryIntegrationTest"
```

### С профилем
```bash
mvn test -Dspring.profiles.active=integration-test
```

### С отладочной информацией
```bash
mvn test -Dtest="*IntegrationTest" -Dlogging.level.com.taskboard.userservice=DEBUG
```

## Требования

### Системные требования
- Docker и Docker Compose
- Java 21+
- Maven 3.8+

### Переменные окружения
```bash
export TESTCONTAINERS_RYUK_DISABLED=true  # Для CI/CD
export TESTCONTAINERS_REUSE_ENABLE=true   # Переиспользование контейнеров
```

## Лучшие практики

### 1. Изоляция тестов
- Каждый тест должен быть независимым
- Использование `@Transactional` для отката изменений
- Очистка данных между тестами

### 2. Производительность
- Переиспользование контейнеров (`withReuse(true)`)
- Параллельное выполнение тестов
- Оптимизация времени выполнения

### 3. Надежность
- Ожидание готовности контейнеров
- Retry логика для нестабильных операций
- Proper cleanup ресурсов

### 4. Читаемость
- Описательные названия тестов
- Использование TestDataFactory
- Группировка связанных тестов

## Отладка

### Логи
```yaml
logging:
  level:
    com.taskboard.userservice: DEBUG
    org.testcontainers: INFO
    org.hibernate.SQL: DEBUG
```

### Docker контейнеры
```bash
# Просмотр запущенных контейнеров
docker ps

# Логи контейнера
docker logs <container_id>

# Очистка контейнеров
docker rm -f $(docker ps -aq --filter "label=org.testcontainers=true")
```

### База данных
```bash
# Подключение к тестовой БД
docker exec -it <postgres_container> psql -U test -d testdb
```

## CI/CD интеграция

### GitHub Actions
```yaml
- name: Run Integration Tests
  run: mvn test -Dtest="*IntegrationTest"
  env:
    TESTCONTAINERS_RYUK_DISABLED: true
```

### Jenkins
```groovy
stage('Integration Tests') {
    steps {
        sh 'mvn test -Dtest="*IntegrationTest"'
    }
    environment {
        TESTCONTAINERS_RYUK_DISABLED = 'true'
    }
}
```

## Метрики

### Покрытие тестами
- Цель: 80%+ покрытие интеграционными тестами
- Критические пути: 100% покрытие
- API endpoints: 100% покрытие

### Производительность
- Время выполнения: < 5 минут для всех тестов
- Время отклика: < 200ms для API
- Throughput: > 100 операций/сек

## Troubleshooting

### Частые проблемы

1. **Контейнеры не запускаются**
   - Проверить Docker daemon
   - Проверить доступные порты
   - Проверить ресурсы системы

2. **Тесты падают с timeout**
   - Увеличить время ожидания
   - Проверить производительность системы
   - Оптимизировать тесты

3. **Проблемы с Kafka**
   - Проверить настройки bootstrap servers
   - Проверить сериализацию/десериализацию
   - Проверить topic configuration

4. **Проблемы с базой данных**
   - Проверить миграции Flyway
   - Проверить connection pool
   - Проверить транзакции

### Решения

1. **Перезапуск контейнеров**
   ```bash
   docker-compose down
   docker-compose up -d
   ```

2. **Очистка ресурсов**
   ```bash
   mvn clean
   docker system prune -f
   ```

3. **Отладка через IDE**
   - Настроить remote debugging
   - Использовать breakpoints
   - Анализировать логи
